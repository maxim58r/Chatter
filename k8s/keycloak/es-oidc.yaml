# Репликация
replicas: 1  # Для single-node кластера должно быть 1
minimumMasterNodes: 1

# Настройки безопасности
security:
  enabled: false  # Отключаем TLS и другие функции безопасности для упрощения
  tls:
    enabled: false
    autoGenerated: false  # Отключаем автоматическую генерацию сертификатов

# Использование keystore для импорта client_secret
keystore:
  - secretName: oidc-client-secret
    items:
      - key: client-secret
        path: xpack.security.authc.realms.oidc.oidc1.rp.client_secret

extraEnvs:
  - name: ELASTIC_PASSWORD
    value: "QJaWS1Bi7ULkaWfJc*Hi"  # Устанавливаем пароль для пользователя elastic

# Конфигурация Elasticsearch
esConfig:
  elasticsearch.yml: |
    cluster.name: "elasticsearch"
    node.name: "elasticsearch-master-0"

    # Режим одиночного узла
    discovery.type: single-node
    node.roles: ["master", "data", "ingest"]

    # Безопасность
    xpack.security.enabled: false
    xpack.security.http.ssl.enabled: false
    xpack.security.transport.ssl.enabled: false

    # OIDC realm для внешних пользователей
    xpack.security.authc.realms.oidc.oidc1.order: 10
    xpack.security.authc.realms.oidc.oidc1.rp.client_id: "myKeycloakClientId"
    xpack.security.authc.realms.oidc.oidc1.rp.response_type: "code"
    xpack.security.authc.realms.oidc.oidc1.rp.redirect_uri: "https://elasticsearch.chatter.com/api/security/v1/oidc"
    xpack.security.authc.realms.oidc.oidc1.rp.post_logout_redirect_uri: "https://elasticsearch.chatter.com/"
    xpack.security.authc.realms.oidc.oidc1.op.authorization_endpoint: "https://192.168.1.35:32080/realms/Chatter/protocol/openid-connect/auth"
    xpack.security.authc.realms.oidc.oidc1.op.issuer: "https://192.168.1.35:32080/realms/Chatter"
    xpack.security.authc.realms.oidc.oidc1.op.jwkset_path: "https://192.168.1.35:32080/realms/Chatter/protocol/openid-connect/certs"
    xpack.security.authc.realms.oidc.oidc1.op.token_endpoint: "https://192.168.1.35:32080/realms/Chatter/protocol/openid-connect/token"
    xpack.security.authc.realms.oidc.oidc1.claims.principal: sub

# Headless сервис
service:
  headless:
    enabled: false  # Отключаем headless сервис для single-node кластера

# Хранилище
volumeClaimTemplate:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 1Gi

# Resource limits and requests
resources:
  requests:
    cpu: "1"
    memory: "1Gi"
  limits:
    cpu: "1"
    memory: "1Gi"

# InitContainers для удаления конфликтующего keystore
initContainers:
  - name: delete-keystore
    image: busybox
    command: ['sh', '-c', 'rm -f /usr/share/elasticsearch/config/elasticsearch.keystore']
    volumeMounts:
      - name: config
        mountPath: /usr/share/elasticsearch/config