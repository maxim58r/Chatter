# Elasticsearch values.yaml
elasticsearch:
  # Включение безопасности Elasticsearch
  security:
    enabled: true
    # Использование существующего сертификата или автоматическая генерация
    tls:
      enabled: true
      autoGenerated: true  # Автоматически сгенерированный сертификат

  # Настройка keystore для хранения секретов
  keystoreSecrets:
    - name: elasticsearch-keystore
      entries:
        - key: xpack.security.authc.realms.oidc.oidc1.rp.client_secret
          valueFrom:
            secretKeyRef:
              name: oidc-client-secret
              key: client-secret

  # Конфигурация Elasticsearch
  config:
    cluster.initial_master_nodes: ["elasticsearch-master-0"]
    discovery.type: single-node  # Одиночный узел
    xpack:
      security:
        authc:
          realms:
            oidc:
              oidc1:
                order: 2  # Изменён порядок OIDC-реалма с 0 на 2, чтобы встроенные пользователи (elastic) аутентифицировались через native/reserved realm
                rp:
                  client_id: "myKeycloakClientId"  # ID клиента в Keycloak
                  client_secret: "${xpack.security.authc.realms.oidc.oidc1.rp.client_secret}"  # Ссылка на секрет
                  redirect_uri: "https://elasticsearch.chatter.com/api/security/v1/oidc"
                  post_logout_redirect_uri: "https://elasticsearch.chatter.com/"
                op:
                  issuer: "http://192.168.1.35:32080/realms/Chatter"  # URL вашего Keycloak реалма
                claims:
                  principal: sub
                  groups: groups
                authentication:
                  request:
                    response_mode: form_post
                logout:
                  type: backchannel
        role_mapping:
          oidc_mapping:
            roles:
              - "admin"
            rules:
              field:
                groups: "admin-group"  # Группа в Keycloak для маппинга на роль admin

  master:
    readinessProbe:
      enabled: false   # Для тестирования можно временно отключить probe
      httpGet:
        path: /
        port: 9200
        scheme: HTTPS
      initialDelaySeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
      periodSeconds: 10
      successThreshold: 1
      # Удалён заголовок Authorization, чтобы не использовались неверные учётные данные

# Настройка секретов для OIDC
secrets:
  oidc-client-secret:
    client-secret: "Y0PZTBYI8XTNRQ8XIfoj9ZmcTVlFbIdG"  # Замените на реальный client_secret из Keycloak

# Настройка сервисов и ингрессов
service:
  type: ClusterIP
  annotations: {}
  ports:
    http: 9200
    transport: 9300

ingress:
  enabled: true
  annotations:
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
  hosts:
    - host: "elasticsearch.chatter.com"
      paths:
        - path: /
          pathType: Prefix
  tls:
    - hosts:
        - "elasticsearch.chatter.com"
      # Используется авто-сгенерированный сертификат, поэтому secretName не указываем

# Ресурсы и масштабирование
resources:
  requests:
    cpu: "250m"
    memory: "512Mi"
  limits:
    cpu: "500m"
    memory: "1Gi"

replicas: 1
